<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="This site lets you export the birthdays from Facebook in a CSV">
    <meta name="author" content="Deepak Mahakale">
    <link rel="shortcut icon" type="image/x-icon" href="/facebook_birthday_export/favicon.ico">
    <title>Facebook Birthdays Export</title>

    <!-- Bootstrap core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-86389306-3"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-86389306-3');
    </script>
  </head>

  <body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark static-top">
      <div class="container">
        <a class="navbar-brand" href="https://deepakmahakale.com/blog">deepakmahakale.com</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav ml-auto">
            <li class="nav-item active">
              <a class="nav-link" href="https://deepakmahakale.com/facebook_birthday_export">Home
                <span class="sr-only">(current)</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="https://deepakmahakale.com/facebook_birthday_export/how_to">How To Get the Elements</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="https://deepakmahakale.com/facebook_birthday_export/upload_to_google_calendar">Upload CSV to Google</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="https://deepakmahakale.com/facebook_birthday_export/known_issues">Known Issues</a>
            </li>
            <!-- <li class="nav-item">
              <a class="nav-link" href="#">Contact</a>
            </li> -->
          </ul>
        </div>
      </div>
    </nav>

    <!-- Page Content -->
    <div class="container">
      <div class="alert alert-success" role="alert">
        Chrome extension is now available <a href="https://chrome.google.com/webstore/detail/social-birthdays-export/enpcedkgdcblopaldlgcajgebojbnhao" target="_blank">Social Birthdays Export</a>
      </div>
      <h1 class="my-3 text-center">Facebook Birthdays Export</h1>
      <div class="text-center" id="mainDiv">
        <textarea id="FbContent" rows="15" cols="100"
                  form="FbForm" placeholder="Paste the facebook html content here.." width="100%"></textarea>
        <form id="FbForm">
          <input type="submit" value="Process" class="btn-primary">
        </form>
      </div>
    </div>

    <!-- Bootstrap core JavaScript -->
    <script src="vendor/jquery/jquery.slim.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script>
      $('#FbForm').on('submit', function () {
        var myRegexp = /data-tooltip-content="(?<name>[a-z0-9- ]+)\((?<month>\d{1,2})\/(?<day>\d{1,2})\)"/gi
        var data = $('#FbContent').val()
        var matched_data = data.match(myRegexp);
        var csv = []
        var today = new Date();
        var current_month = today.getMonth() + 1
        var current_day = today.getDate()
        var current_year = today.getFullYear()
        csv.push(['Subject', 'Start date', 'All Day Event'])
        matched_data.forEach(function (element) {
          match = new RegExp(myRegexp).exec(element)
          try {
            if(match.groups){
              var group = match.groups
              var day = parseInt(group['day'])
              var month = parseInt(group['month'])
              if(month < current_month || (month == current_month && day < current_day)) {
                var year = current_year + 1
              } else {
                var year = current_year
              }
              var date = `${day}/${month}/${year}`
              csv.push([group['name'].trim() , date, 'True']);
            }
          } catch (error) {
            return false;
          }
        });
        let csvContent = "data:text/csv;charset=utf-8," + csv.map(e => e.join(",")).join("\n");
        var encodedUri = encodeURI(csvContent);
        var link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("class", "btn btn-success")
        link.setAttribute("download", "birthdays.csv");
        link.innerHTML = "Download CSV"
        $('#mainDiv').append(link);
        $('#FbContent').hide();
        $('#FbForm').hide();
        return false;
      });
    </script>
  </body>
</html>
